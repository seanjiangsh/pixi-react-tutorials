import type { Meta, StoryObj } from "@storybook/react-vite";
import { PixiSceneDecorator } from "../storybook-decorator";
import Lightning from "./Lightning";
import type {
  BorderBoltProps,
  TravelBoltProps,
  BoltDemoProps,
} from "./Lightning";
import "./GridOverlay.css";
import {
  borderBoltControls,
  travelBoltControls,
  lightningControls,
} from "./lightningControls";

// Flattened props for Storybook controls
type LightningStoryProps = {
  isPixi?: boolean;
} & {
  [K in keyof Required<BorderBoltProps> as `borderBolt_${K &
    string}`]?: BorderBoltProps[K];
} & {
  [K in keyof Required<TravelBoltProps> as `travelBolt_${K &
    string}`]?: TravelBoltProps[K];
} & {
  [K in keyof Required<BoltDemoProps> as `boltDemo_${K &
    string}`]?: BoltDemoProps[K];
};

const meta = {
  title: "Scenes/Lightning",
  component: Lightning,
  parameters: {
    layout: "fullscreen",
  },
  decorators: [
    PixiSceneDecorator,
    (Story, context) => {
      // Map flattened props back to hierarchical structure
      const { args } = context;
      const borderBolt: BorderBoltProps = {};
      const travelBolt: TravelBoltProps = {};
      const boltDemo: BoltDemoProps = {};

      Object.keys(args).forEach((key) => {
        if (key.startsWith("borderBolt_")) {
          const propKey = key.replace(
            "borderBolt_",
            ""
          ) as keyof BorderBoltProps;
          borderBolt[propKey] = args[key];
        } else if (key.startsWith("travelBolt_")) {
          const propKey = key.replace(
            "travelBolt_",
            ""
          ) as keyof TravelBoltProps;
          travelBolt[propKey] = args[key];
        } else if (key.startsWith("boltDemo_")) {
          const propKey = key.replace("boltDemo_", "") as keyof BoltDemoProps;
          boltDemo[propKey] = args[key];
        }
      });

      return <Story args={{ ...args, borderBolt, travelBolt, boltDemo }} />;
    },
  ],
  argTypes: {
    // Border Bolt controls
    borderBolt_enableLightning: {
      control: "boolean",
      description: borderBoltControls.enableLightning.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_jaggedAmplitude: {
      control: {
        type: "range",
        min: borderBoltControls.jaggedAmplitude.min,
        max: borderBoltControls.jaggedAmplitude.max,
        step: borderBoltControls.jaggedAmplitude.step,
      },
      description: borderBoltControls.jaggedAmplitude.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_jaggedFrequency1: {
      control: {
        type: "range",
        min: borderBoltControls.jaggedFrequency1.min,
        max: borderBoltControls.jaggedFrequency1.max,
        step: borderBoltControls.jaggedFrequency1.step,
      },
      description: borderBoltControls.jaggedFrequency1.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_jaggedFrequency2: {
      control: {
        type: "range",
        min: borderBoltControls.jaggedFrequency2.min,
        max: borderBoltControls.jaggedFrequency2.max,
        step: borderBoltControls.jaggedFrequency2.step,
      },
      description: borderBoltControls.jaggedFrequency2.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_jaggedFrequency3: {
      control: {
        type: "range",
        min: borderBoltControls.jaggedFrequency3.min,
        max: borderBoltControls.jaggedFrequency3.max,
        step: borderBoltControls.jaggedFrequency3.step,
      },
      description: borderBoltControls.jaggedFrequency3.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_timeScale: {
      control: {
        type: "range",
        min: borderBoltControls.timeScale.min,
        max: borderBoltControls.timeScale.max,
        step: borderBoltControls.timeScale.step,
      },
      description: borderBoltControls.timeScale.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_randomness: {
      control: {
        type: "range",
        min: borderBoltControls.randomness.min,
        max: borderBoltControls.randomness.max,
        step: borderBoltControls.randomness.step,
      },
      description: borderBoltControls.randomness.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_inset: {
      control: {
        type: "range",
        min: borderBoltControls.inset.min,
        max: borderBoltControls.inset.max,
        step: borderBoltControls.inset.step,
      },
      description: borderBoltControls.inset.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_borderRadius: {
      control: {
        type: "range",
        min: borderBoltControls.borderRadius.min,
        max: borderBoltControls.borderRadius.max,
        step: borderBoltControls.borderRadius.step,
      },
      description: borderBoltControls.borderRadius.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_lineWidth: {
      control: {
        type: "range",
        min: borderBoltControls.lineWidth.min,
        max: borderBoltControls.lineWidth.max,
        step: borderBoltControls.lineWidth.step,
      },
      description: borderBoltControls.lineWidth.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_branchProbability: {
      control: {
        type: "range",
        min: borderBoltControls.branchProbability.min,
        max: borderBoltControls.branchProbability.max,
        step: borderBoltControls.branchProbability.step,
      },
      description: borderBoltControls.branchProbability.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_branchLength: {
      control: {
        type: "range",
        min: borderBoltControls.branchLength.min,
        max: borderBoltControls.branchLength.max,
        step: borderBoltControls.branchLength.step,
      },
      description: borderBoltControls.branchLength.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_startDelay: {
      control: {
        type: "range",
        min: borderBoltControls.startDelay.min,
        max: borderBoltControls.startDelay.max,
        step: borderBoltControls.startDelay.step,
      },
      description: borderBoltControls.startDelay.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_roundDuration: {
      control: {
        type: "range",
        min: borderBoltControls.roundDuration.min,
        max: borderBoltControls.roundDuration.max,
        step: borderBoltControls.roundDuration.step,
      },
      description: borderBoltControls.roundDuration.label,
      table: { category: "Border Bolt" },
    },
    borderBolt_growthDuration: {
      control: {
        type: "range",
        min: borderBoltControls.growthDuration.min,
        max: borderBoltControls.growthDuration.max,
        step: borderBoltControls.growthDuration.step,
      },
      description: borderBoltControls.growthDuration.label,
      table: { category: "Border Bolt" },
    },
    // Travel Bolt controls
    travelBolt_boltCount: {
      control: {
        type: "range",
        min: travelBoltControls.boltCount.min,
        max: travelBoltControls.boltCount.max,
        step: travelBoltControls.boltCount.step,
      },
      description: travelBoltControls.boltCount.label,
      table: { category: "Travel Bolt" },
    },
    travelBolt_displacement: {
      control: {
        type: "range",
        min: travelBoltControls.displacement.min,
        max: travelBoltControls.displacement.max,
        step: travelBoltControls.displacement.step,
      },
      description: travelBoltControls.displacement.label,
      table: { category: "Travel Bolt" },
    },
    travelBolt_jaggedness: {
      control: {
        type: "range",
        min: travelBoltControls.jaggedness.min,
        max: travelBoltControls.jaggedness.max,
        step: travelBoltControls.jaggedness.step,
      },
      description: travelBoltControls.jaggedness.label,
      table: { category: "Travel Bolt" },
    },
    travelBolt_branchProbability: {
      control: {
        type: "range",
        min: travelBoltControls.branchProbability.min,
        max: travelBoltControls.branchProbability.max,
        step: travelBoltControls.branchProbability.step,
      },
      description: travelBoltControls.branchProbability.label,
      table: { category: "Travel Bolt" },
    },
    travelBolt_branchLength: {
      control: {
        type: "range",
        min: travelBoltControls.branchLength.min,
        max: travelBoltControls.branchLength.max,
        step: travelBoltControls.branchLength.step,
      },
      description: travelBoltControls.branchLength.label,
      table: { category: "Travel Bolt" },
    },
    travelBolt_travelDuration: {
      control: {
        type: "range",
        min: travelBoltControls.travelDuration.min,
        max: travelBoltControls.travelDuration.max,
        step: travelBoltControls.travelDuration.step,
      },
      description: travelBoltControls.travelDuration.label,
      table: { category: "Travel Bolt" },
    },
    // Bolt Demo controls
    boltDemo_boltAmount: {
      control: {
        type: "range",
        min: lightningControls.boltAmount.min,
        max: lightningControls.boltAmount.max,
        step: lightningControls.boltAmount.step,
      },
      description: lightningControls.boltAmount.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_displacement: {
      control: {
        type: "range",
        min: lightningControls.displacement.min,
        max: lightningControls.displacement.max,
        step: lightningControls.displacement.step,
      },
      description: lightningControls.displacement.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_jaggedness: {
      control: {
        type: "range",
        min: lightningControls.jaggedness.min,
        max: lightningControls.jaggedness.max,
        step: lightningControls.jaggedness.step,
      },
      description: lightningControls.jaggedness.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_segmentPoints: {
      control: {
        type: "range",
        min: lightningControls.segmentPoints.min,
        max: lightningControls.segmentPoints.max,
        step: lightningControls.segmentPoints.step,
      },
      description: lightningControls.segmentPoints.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_segmentDensity: {
      control: {
        type: "range",
        min: lightningControls.segmentDensity.min,
        max: lightningControls.segmentDensity.max,
        step: lightningControls.segmentDensity.step,
      },
      description: lightningControls.segmentDensity.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_envelopeShape: {
      control: {
        type: "range",
        min: lightningControls.envelopeShape.min,
        max: lightningControls.envelopeShape.max,
        step: lightningControls.envelopeShape.step,
      },
      description: lightningControls.envelopeShape.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_smoothingIterations: {
      control: {
        type: "range",
        min: lightningControls.smoothingIterations.min,
        max: lightningControls.smoothingIterations.max,
        step: lightningControls.smoothingIterations.step,
      },
      description: lightningControls.smoothingIterations.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_lineWidth: {
      control: {
        type: "range",
        min: lightningControls.lineWidth.min,
        max: lightningControls.lineWidth.max,
        step: lightningControls.lineWidth.step,
      },
      description: lightningControls.lineWidth.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_lineWidthVariation: {
      control: {
        type: "range",
        min: lightningControls.lineWidthVariation.min,
        max: lightningControls.lineWidthVariation.max,
        step: lightningControls.lineWidthVariation.step,
      },
      description: lightningControls.lineWidthVariation.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_opacityVariation: {
      control: {
        type: "range",
        min: lightningControls.opacityVariation.min,
        max: lightningControls.opacityVariation.max,
        step: lightningControls.opacityVariation.step,
      },
      description: lightningControls.opacityVariation.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_boltColor1: {
      control: "color",
      description: lightningControls.boltColor1.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_boltColor2: {
      control: "color",
      description: lightningControls.boltColor2.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_boltColor3: {
      control: "color",
      description: lightningControls.boltColor3.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_glowDistance: {
      control: {
        type: "range",
        min: lightningControls.glowDistance.min,
        max: lightningControls.glowDistance.max,
        step: lightningControls.glowDistance.step,
      },
      description: lightningControls.glowDistance.label,
      table: { category: "Bolt Demo" },
    },
    boltDemo_oscillationCycle: {
      control: {
        type: "range",
        min: lightningControls.oscillationCycle.min,
        max: lightningControls.oscillationCycle.max,
        step: lightningControls.oscillationCycle.step,
      },
      description: lightningControls.oscillationCycle.label,
      table: { category: "Bolt Demo" },
    },
  },
} satisfies Meta<LightningStoryProps>;

export default meta;
type Story = StoryObj<typeof meta>;

export const Default: Story = {
  args: {},
};
