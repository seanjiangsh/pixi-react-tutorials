import{E as ct,d as I,v as P,D as H,T as $,C as E,M as V,F as dt,a as ut,w as st,b as q,R as N,I as ft,c as X,e as y,n as J}from"./useSceneSize-DJAQ_TmF.js";import{C as j}from"./CanvasPool-BnIdLYxx.js";class pt extends ct{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.applyFillAsTint=!0,this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return I(P,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}get pageTextures(){return I(P,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}get size(){return I(P,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}get distanceFieldRange(){return I(P,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}get distanceFieldType(){return I(P,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}destroy(e=!1){var t;this.emit("destroy",this),this.removeAllListeners();for(const i in this.chars)(t=this.chars[i].texture)==null||t.destroy();this.chars=null,e&&(this.pages.forEach(i=>i.texture.destroy(!0)),this.pages=null)}}/**
 * tiny-lru
 *
 * @copyright 2025 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.4.5
 */class gt{constructor(e=0,t=0,i=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=i,this.size=0,this.ttl=t}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const t=this.items[e];delete this.items[e],this.size--,t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),this.last===t&&(this.last=t.prev)}return this}entries(e=this.keys()){return e.map(t=>[t,this.get(t)])}evict(e=!1){if(e||this.size>0){const t=this.first;delete this.items[t.key],--this.size===0?(this.first=null,this.last=null):(this.first=t.next,this.first.prev=null)}return this}expiresAt(e){let t;return this.has(e)&&(t=this.items[e].expiry),t}get(e){const t=this.items[e];if(t!==void 0){if(this.ttl>0&&t.expiry<=Date.now()){this.delete(e);return}return this.moveToEnd(t),t.value}}has(e){return e in this.items}moveToEnd(e){this.last!==e&&(e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),e.prev=this.last,e.next=null,this.last!==null&&(this.last.next=e),this.last=e,this.first===null&&(this.first=e))}keys(){const e=[];let t=this.first;for(;t!==null;)e.push(t.key),t=t.next;return e}setWithEvicted(e,t,i=this.resetTtl){let s=null;if(this.has(e))this.set(e,t,!0,i);else{this.max>0&&this.size===this.max&&(s={...this.first},this.evict(!0));let n=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t};++this.size===1?this.first=n:this.last.next=n,this.last=n}return s}set(e,t,i=!1,s=this.resetTtl){let n=this.items[e];return i||n!==void 0?(n.value=t,i===!1&&s&&(n.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(n)):(this.max>0&&this.size===this.max&&this.evict(!0),n=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t},++this.size===1?this.first=n:this.last.next=n,this.last=n),this}values(e=this.keys()){return e.map(t=>this.get(t))}}function nt(h=1e3,e=0,t=!1){if(isNaN(h)||h<0)throw new TypeError("Invalid max value");if(isNaN(e)||e<0)throw new TypeError("Invalid ttl value");if(typeof t!="boolean")throw new TypeError("Invalid resetTtl value");return new gt(h,e,t)}const mt=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function D(h){const e=typeof h.fontSize=="number"?`${h.fontSize}px`:h.fontSize;let t=h.fontFamily;Array.isArray(h.fontFamily)||(t=h.fontFamily.split(","));for(let i=t.length-1;i>=0;i--){let s=t[i].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!mt.includes(s)&&(s=`"${s}"`),t[i]=s}return`${h.fontStyle} ${h.fontVariant} ${h.fontWeight} ${e} ${t.join(",")}`}const G={willReadFrequently:!0},L=class d{static get experimentalLetterSpacingSupported(){let e=d._experimentalLetterSpacingSupported;if(e===void 0){const t=H.get().getCanvasRenderingContext2D().prototype;e=d._experimentalLetterSpacingSupported="letterSpacing"in t||"textLetterSpacing"in t}return e}constructor(e,t,i,s,n,a,r,o,l){this.text=e,this.style=t,this.width=i,this.height=s,this.lines=n,this.lineWidths=a,this.lineHeight=r,this.maxLineWidth=o,this.fontProperties=l}static measureText(e=" ",t,i=d._canvas,s=t.wordWrap){var m;const n=`${e}-${t.styleKey}-wordWrap-${s}`;if(d._measurementCache.has(n))return d._measurementCache.get(n);const a=D(t),r=d.measureFont(a);r.fontSize===0&&(r.fontSize=t.fontSize,r.ascent=t.fontSize);const o=d.__context;o.font=a;const c=(s?d._wordWrap(e,t,i):e).split(/(?:\r\n|\r|\n)/),u=new Array(c.length);let f=0;for(let g=0;g<c.length;g++){const x=d._measureText(c[g],t.letterSpacing,o);u[g]=x,f=Math.max(f,x)}const w=((m=t._stroke)==null?void 0:m.width)||0;let S=f+w;t.dropShadow&&(S+=t.dropShadow.distance);const C=t.lineHeight||r.fontSize;let _=Math.max(C,r.fontSize+w)+(c.length-1)*(C+t.leading);t.dropShadow&&(_+=t.dropShadow.distance);const p=new d(e,t,S,_,c,u,C+t.leading,f,r);return d._measurementCache.set(n,p),p}static _measureText(e,t,i){let s=!1;d.experimentalLetterSpacingSupported&&(d.experimentalLetterSpacing?(i.letterSpacing=`${t}px`,i.textLetterSpacing=`${t}px`,s=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));const n=i.measureText(e);let a=n.width;const r=-n.actualBoundingBoxLeft;let l=n.actualBoundingBoxRight-r;if(a>0)if(s)a-=t,l-=t;else{const c=(d.graphemeSegmenter(e).length-1)*t;a+=c,l+=c}return Math.max(a,l)}static _wordWrap(e,t,i=d._canvas){const s=i.getContext("2d",G);let n=0,a="",r="";const o=Object.create(null),{letterSpacing:l,whiteSpace:c}=t,u=d._collapseSpaces(c),f=d._collapseNewlines(c);let w=!u;const S=t.wordWrapWidth+l,C=d._tokenize(e);for(let _=0;_<C.length;_++){let p=C[_];if(d._isNewline(p)){if(!f){r+=d._addLine(a),w=!u,a="",n=0;continue}p=" "}if(u){const g=d.isBreakingSpace(p),x=d.isBreakingSpace(a[a.length-1]);if(g&&x)continue}const m=d._getFromCache(p,l,o,s);if(m>S)if(a!==""&&(r+=d._addLine(a),a="",n=0),d.canBreakWords(p,t.breakWords)){const g=d.wordWrapSplit(p);for(let x=0;x<g.length;x++){let B=g[x],b=B,v=1;for(;g[x+v];){const k=g[x+v];if(!d.canBreakChars(b,k,p,x,t.breakWords))B+=k;else break;b=k,v++}x+=v-1;const T=d._getFromCache(B,l,o,s);T+n>S&&(r+=d._addLine(a),w=!1,a="",n=0),a+=B,n+=T}}else{a.length>0&&(r+=d._addLine(a),a="",n=0);const g=_===C.length-1;r+=d._addLine(p,!g),w=!1,a="",n=0}else m+n>S&&(w=!1,r+=d._addLine(a),a="",n=0),(a.length>0||!d.isBreakingSpace(p)||w)&&(a+=p,n+=m)}return r+=d._addLine(a,!1),r}static _addLine(e,t=!0){return e=d._trimRight(e),e=t?`${e}
`:e,e}static _getFromCache(e,t,i,s){let n=i[e];return typeof n!="number"&&(n=d._measureText(e,t,s)+t,i[e]=n),n}static _collapseSpaces(e){return e==="normal"||e==="pre-line"}static _collapseNewlines(e){return e==="normal"}static _trimRight(e){if(typeof e!="string")return"";for(let t=e.length-1;t>=0;t--){const i=e[t];if(!d.isBreakingSpace(i))break;e=e.slice(0,-1)}return e}static _isNewline(e){return typeof e!="string"?!1:d._newlines.includes(e.charCodeAt(0))}static isBreakingSpace(e,t){return typeof e!="string"?!1:d._breakingSpaces.includes(e.charCodeAt(0))}static _tokenize(e){const t=[];let i="";if(typeof e!="string")return t;for(let s=0;s<e.length;s++){const n=e[s],a=e[s+1];if(d.isBreakingSpace(n,a)||d._isNewline(n)){i!==""&&(t.push(i),i=""),n==="\r"&&a===`
`?(t.push(`\r
`),s++):t.push(n);continue}i+=n}return i!==""&&t.push(i),t}static canBreakWords(e,t){return t}static canBreakChars(e,t,i,s,n){return!0}static wordWrapSplit(e){return d.graphemeSegmenter(e)}static measureFont(e){if(d._fonts[e])return d._fonts[e];const t=d._context;t.font=e;const i=t.measureText(d.METRICS_STRING+d.BASELINE_SYMBOL),s={ascent:i.actualBoundingBoxAscent,descent:i.actualBoundingBoxDescent,fontSize:i.actualBoundingBoxAscent+i.actualBoundingBoxDescent};return d._fonts[e]=s,s}static clearMetrics(e=""){e?delete d._fonts[e]:d._fonts={}}static get _canvas(){if(!d.__canvas){let e;try{const t=new OffscreenCanvas(0,0),i=t.getContext("2d",G);if(i!=null&&i.measureText)return d.__canvas=t,t;e=H.get().createCanvas()}catch{e=H.get().createCanvas()}e.width=e.height=10,d.__canvas=e}return d.__canvas}static get _context(){return d.__context||(d.__context=d._canvas.getContext("2d",G)),d.__context}};L.METRICS_STRING="|ÉqÅ";L.BASELINE_SYMBOL="M";L.BASELINE_MULTIPLIER=1.4;L.HEIGHT_MULTIPLIER=2;L.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const h=new Intl.Segmenter;return e=>{const t=h.segment(e),i=[];let s=0;for(const n of t)i[s++]=n.segment;return i}}return h=>[...h]})();L.experimentalLetterSpacing=!1;L._fonts={};L._newlines=[10,13];L._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];L._measurementCache=nt(1e3);let M=L;const Z=1e5;function K(h,e,t,i=0){if(h.texture===$.WHITE&&!h.fill)return E.shared.setValue(h.color).setAlpha(h.alpha??1).toHexa();if(h.fill){if(h.fill instanceof dt){const s=h.fill,n=e.createPattern(s.texture.source.resource,"repeat"),a=s.transform.copyTo(V.shared);return a.scale(s.texture.frame.width,s.texture.frame.height),n.setTransform(a),n}else if(h.fill instanceof ut){const s=h.fill,n=s.type==="linear",a=s.textureSpace==="local";let r=1,o=1;a&&t&&(r=t.width+i,o=t.height+i);let l,c=!1;if(n){const{start:u,end:f}=s;l=e.createLinearGradient(u.x*r,u.y*o,f.x*r,f.y*o),c=Math.abs(f.x-u.x)<Math.abs((f.y-u.y)*.1)}else{const{center:u,innerRadius:f,outerCenter:w,outerRadius:S}=s;l=e.createRadialGradient(u.x*r,u.y*o,f*r,w.x*r,w.y*o,S*r)}if(c&&a&&t){const u=t.lineHeight/o;for(let f=0;f<t.lines.length;f++){const w=(f*t.lineHeight+i/2)/o;s.colorStops.forEach(S=>{const C=w+S.offset*u;l.addColorStop(Math.floor(C*Z)/Z,E.shared.setValue(S.color).toHex())})}}else s.colorStops.forEach(u=>{l.addColorStop(u.offset,E.shared.setValue(u.color).toHex())});return l}}else{const s=e.createPattern(h.texture.source.resource,"repeat"),n=h.matrix.copyTo(V.shared);return n.scale(h.texture.frame.width,h.texture.frame.height),s.setTransform(n),s}return st("FillStyle not recognised",h),"red"}const rt=class at extends pt{constructor(e){super(),this.resolution=1,this.pages=[],this._padding=0,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentMaxCharHeight=0,this._currentPageIndex=-1,this._skipKerning=!1;const t={...at.defaultOptions,...e};this._textureSize=t.textureSize,this._mipmap=t.mipmap;const i=t.style.clone();t.overrideFill&&(i._fill.color=16777215,i._fill.alpha=1,i._fill.texture=$.WHITE,i._fill.fill=null),this.applyFillAsTint=t.overrideFill;const s=i.fontSize;i.fontSize=this.baseMeasurementFontSize;const n=D(i);t.overrideSize?i._stroke&&(i._stroke.width*=this.baseRenderedFontSize/s):i.fontSize=this.baseRenderedFontSize=s,this._style=i,this._skipKerning=t.skipKerning??!1,this.resolution=t.resolution??1,this._padding=t.padding??4,t.textureStyle&&(this._textureStyle=t.textureStyle instanceof q?t.textureStyle:new q(t.textureStyle)),this.fontMetrics=M.measureFont(n),this.lineHeight=i.lineHeight||this.fontMetrics.fontSize||i.fontSize}ensureCharacters(e){var _,p;const t=M.graphemeSegmenter(e).filter(m=>!this._currentChars.includes(m)).filter((m,g,x)=>x.indexOf(m)===g);if(!t.length)return;this._currentChars=[...this._currentChars,...t];let i;this._currentPageIndex===-1?i=this._nextPage():i=this.pages[this._currentPageIndex];let{canvas:s,context:n}=i.canvasAndContext,a=i.texture.source;const r=this._style;let o=this._currentX,l=this._currentY,c=this._currentMaxCharHeight;const u=this.baseRenderedFontSize/this.baseMeasurementFontSize,f=this._padding*u;let w=!1;const S=s.width/this.resolution,C=s.height/this.resolution;for(let m=0;m<t.length;m++){const g=t[m],x=M.measureText(g,r,s,!1);x.lineHeight=x.height;const B=x.width*u,b=Math.ceil((r.fontStyle==="italic"?2:1)*B),v=x.height*u,T=b+f*2,k=v+f*2;if(w=!1,g!==`
`&&g!=="\r"&&g!=="	"&&g!==" "&&(w=!0,c=Math.ceil(Math.max(k,c))),o+T>S&&(l+=c,c=k,o=0,l+c>C)){a.update();const W=this._nextPage();s=W.canvasAndContext.canvas,n=W.canvasAndContext.context,a=W.texture.source,o=0,l=0,c=0}const Y=B/u-(((_=r.dropShadow)==null?void 0:_.distance)??0)-(((p=r._stroke)==null?void 0:p.width)??0);if(this.chars[g]={id:g.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:Y,kerning:{}},w){this._drawGlyph(n,x,o+f,l+f,u,r);const W=a.width*u,O=a.height*u,F=new N(o/W*a.width,l/O*a.height,T/W*a.width,k/O*a.height);this.chars[g].texture=new $({source:a,frame:F}),o+=Math.ceil(T)}}a.update(),this._currentX=o,this._currentY=l,this._currentMaxCharHeight=c,this._skipKerning&&this._applyKerning(t,n)}get pageTextures(){return I(P,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}_applyKerning(e,t){const i=this._measureCache;for(let s=0;s<e.length;s++){const n=e[s];for(let a=0;a<this._currentChars.length;a++){const r=this._currentChars[a];let o=i[n];o||(o=i[n]=t.measureText(n).width);let l=i[r];l||(l=i[r]=t.measureText(r).width);let c=t.measureText(n+r).width,u=c-(o+l);u&&(this.chars[n].kerning[r]=u),c=t.measureText(n+r).width,u=c-(o+l),u&&(this.chars[r].kerning[n]=u)}}}_nextPage(){this._currentPageIndex++;const e=this.resolution,t=j.getOptimalCanvasAndContext(this._textureSize,this._textureSize,e);this._setupContext(t.context,this._style,e);const i=e*(this.baseRenderedFontSize/this.baseMeasurementFontSize),s=new $({source:new ft({resource:t.canvas,resolution:i,alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:this._mipmap})});this._textureStyle&&(s.source.style=this._textureStyle);const n={canvasAndContext:t,texture:s};return this.pages[this._currentPageIndex]=n,n}_setupContext(e,t,i){t.fontSize=this.baseRenderedFontSize,e.scale(i,i),e.font=D(t),t.fontSize=this.baseMeasurementFontSize,e.textBaseline=t.textBaseline;const s=t._stroke,n=(s==null?void 0:s.width)??0;if(s&&(e.lineWidth=n,e.lineJoin=s.join,e.miterLimit=s.miterLimit,e.strokeStyle=K(s,e)),t._fill&&(e.fillStyle=K(t._fill,e)),t.dropShadow){const a=t.dropShadow,r=E.shared.setValue(a.color).toArray(),o=a.blur*i,l=a.distance*i;e.shadowColor=`rgba(${r[0]*255},${r[1]*255},${r[2]*255},${a.alpha})`,e.shadowBlur=o,e.shadowOffsetX=Math.cos(a.angle)*l,e.shadowOffsetY=Math.sin(a.angle)*l}else e.shadowColor="black",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0}_drawGlyph(e,t,i,s,n,a){const r=t.text,o=t.fontProperties,l=a._stroke,c=((l==null?void 0:l.width)??0)*n,u=i+c/2,f=s-c/2,w=o.descent*n,S=t.lineHeight*n;let C=!1;a.stroke&&c&&(C=!0,e.strokeText(r,u,f+S-w));const{shadowBlur:_,shadowOffsetX:p,shadowOffsetY:m}=e;a._fill&&(C&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.fillText(r,u,f+S-w)),C&&(e.shadowBlur=_,e.shadowOffsetX=p,e.shadowOffsetY=m)}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{canvasAndContext:t,texture:i}=this.pages[e];j.returnCanvasAndContext(t),i.destroy(!0)}this.pages=null}};rt.defaultOptions={textureSize:512,style:new X,mipmap:!0};let Q=rt;function xt(h,e,t,i){const s={width:0,height:0,offsetY:0,scale:e.fontSize/t.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};s.offsetY=t.baseLineOffset;let n=s.lines[0],a=null,r=!0;const o={width:0,start:0,index:0,positions:[],chars:[]},l=t.baseMeasurementFontSize/e.fontSize,c=e.letterSpacing*l,u=e.wordWrapWidth*l,f=e.lineHeight?e.lineHeight*l:t.lineHeight,w=e.wordWrap&&e.breakWords,S=p=>{const m=n.width;for(let g=0;g<o.index;g++){const x=p.positions[g];n.chars.push(p.chars[g]),n.charPositions.push(x+m)}n.width+=p.width,r=!1,o.width=0,o.index=0,o.chars.length=0},C=()=>{let p=n.chars.length-1;if(i){let m=n.chars[p];for(;m===" ";)n.width-=t.chars[m].xAdvance,m=n.chars[--p]}s.width=Math.max(s.width,n.width),n={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},r=!0,s.lines.push(n),s.height+=f},_=p=>p-c>u;for(let p=0;p<h.length+1;p++){let m;const g=p===h.length;g||(m=h[p]);const x=t.chars[m]||t.chars[" "];if(/(?:\s)/.test(m)||m==="\r"||m===`
`||g){if(!r&&e.wordWrap&&_(n.width+o.width)?(C(),S(o),g||n.charPositions.push(0)):(o.start=n.width,S(o),g||n.charPositions.push(0)),m==="\r"||m===`
`)C();else if(!g){const T=x.xAdvance+(x.kerning[a]||0)+c;n.width+=T,n.spaceWidth=T,n.spacesIndex.push(n.charPositions.length),n.chars.push(m)}}else{const v=x.kerning[a]||0,T=x.xAdvance+v+c;w&&_(n.width+o.width+T)&&(S(o),C()),o.positions[o.index++]=o.width+v,o.chars.push(m),o.width+=T}a=m}return C(),e.align==="center"?wt(s):e.align==="right"?St(s):e.align==="justify"&&Ct(s),s}function wt(h){for(let e=0;e<h.lines.length;e++){const t=h.lines[e],i=h.width/2-t.width/2;for(let s=0;s<t.charPositions.length;s++)t.charPositions[s]+=i}}function St(h){for(let e=0;e<h.lines.length;e++){const t=h.lines[e],i=h.width-t.width;for(let s=0;s<t.charPositions.length;s++)t.charPositions[s]+=i}}function Ct(h){const e=h.width;for(let t=0;t<h.lines.length;t++){const i=h.lines[t];let s=0,n=i.spacesIndex[s++],a=0;const r=i.spacesIndex.length,l=(e-i.width)/r;for(let c=0;c<i.charPositions.length;c++)c===n&&(n=i.spacesIndex[s++],a+=l),i.charPositions[c]+=a}}function _t(h){if(h==="")return[];typeof h=="string"&&(h=[h]);const e=[];for(let t=0,i=h.length;t<i;t++){const s=h[t];if(Array.isArray(s)){if(s.length!==2)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${s.length}.`);if(s[0].length===0||s[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");const n=s[0].charCodeAt(0),a=s[1].charCodeAt(0);if(a<n)throw new Error("[BitmapFont]: Invalid character range.");for(let r=n,o=a;r<=o;r++)e.push(String.fromCharCode(r))}else e.push(...Array.from(s))}if(e.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return e}let R=0;class vt{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1,textureStyle:null},this.measureCache=nt(1e3)}getFont(e,t){var a;let i=`${t.fontFamily}-bitmap`,s=!0;if(t._fill.fill&&!t._stroke?(i+=t._fill.fill.styleKey,s=!1):(t._stroke||t.dropShadow)&&(i=`${t.styleKey}-bitmap`,s=!1),!y.has(i)){const r=Object.create(t);r.lineHeight=0;const o=new Q({style:r,overrideFill:s,overrideSize:!0,...this.defaultOptions});R++,R>50&&st("BitmapText",`You have dynamically created ${R} bitmap fonts, this can be inefficient. Try pre installing your font styles using \`BitmapFont.install({name:"style1", style})\``),o.once("destroy",()=>{R--,y.remove(i)}),y.set(i,o)}const n=y.get(i);return(a=n.ensureCharacters)==null||a.call(n,e),n}getLayout(e,t,i=!0){const s=this.getFont(e,t),n=`${e}-${t.styleKey}-${i}`;if(this.measureCache.has(n))return this.measureCache.get(n);const a=M.graphemeSegmenter(e),r=xt(a,t,s,i);return this.measureCache.set(n,r),r}measureText(e,t,i=!0){return this.getLayout(e,t,i)}install(...e){var l,c,u,f;let t=e[0];typeof t=="string"&&(t={name:t,style:e[1],chars:(l=e[2])==null?void 0:l.chars,resolution:(c=e[2])==null?void 0:c.resolution,padding:(u=e[2])==null?void 0:u.padding,skipKerning:(f=e[2])==null?void 0:f.skipKerning},I(P,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})"));const i=t==null?void 0:t.name;if(!i)throw new Error("[BitmapFontManager] Property `name` is required.");t={...this.defaultOptions,...t};const s=t.style,n=s instanceof X?s:new X(s),a=t.dynamicFill??this._canUseTintForStyle(n),r=new Q({style:n,overrideFill:a,skipKerning:t.skipKerning,padding:t.padding,resolution:t.resolution,overrideSize:!1,textureStyle:t.textureStyle}),o=_t(t.chars);return r.ensureCharacters(o.join("")),y.set(`${i}-bitmap`,r),r.once("destroy",()=>y.remove(`${i}-bitmap`)),r}uninstall(e){const t=`${e}-bitmap`,i=y.get(t);i&&i.destroy()}_canUseTintForStyle(e){return!e._stroke&&(!e.dropShadow||e.dropShadow.color===0)&&!e._fill.fill&&e._fill.color===16777215}}const Wt=new vt;let A=null,z=null;function Ft(h,e){A||(A=H.get().createCanvas(256,128),z=A.getContext("2d",{willReadFrequently:!0}),z.globalCompositeOperation="copy",z.globalAlpha=1),(A.width<h||A.height<e)&&(A.width=J(h),A.height=J(e))}function tt(h,e,t){for(let i=0,s=4*t*e;i<e;++i,s+=4)if(h[s+3]!==0)return!1;return!0}function et(h,e,t,i,s){const n=4*e;for(let a=i,r=i*n+4*t;a<=s;++a,r+=n)if(h[r+3]!==0)return!1;return!0}function Tt(...h){let e=h[0];e.canvas||(e={canvas:h[0],resolution:h[1]});const{canvas:t}=e,i=Math.min(e.resolution??1,1),s=e.width??t.width,n=e.height??t.height;let a=e.output;if(Ft(s,n),!z)throw new TypeError("Failed to get canvas 2D context");z.drawImage(t,0,0,s,n,0,0,s*i,n*i);const o=z.getImageData(0,0,s,n).data;let l=0,c=0,u=s-1,f=n-1;for(;c<n&&tt(o,s,c);)++c;if(c===n)return N.EMPTY;for(;tt(o,s,f);)--f;for(;et(o,s,l,c,f);)++l;for(;et(o,s,u,c,f);)--u;return++u,++f,z.globalCompositeOperation="source-over",z.strokeRect(l,c,u-l,f-c),z.globalCompositeOperation="copy",a??(a=new N),a.set(l/i,c/i,(u-l)/i,(f-c)/i),a}const it=new N;class kt{getCanvasAndContext(e){const{text:t,style:i,resolution:s=1}=e,n=i._getFinalPadding(),a=M.measureText(t||" ",i),r=Math.ceil(Math.ceil(Math.max(1,a.width)+n*2)*s),o=Math.ceil(Math.ceil(Math.max(1,a.height)+n*2)*s),l=j.getOptimalCanvasAndContext(r,o);this._renderTextToCanvas(t,i,n,s,l);const c=i.trim?Tt({canvas:l.canvas,width:r,height:o,resolution:1,output:it}):it.set(0,0,r,o);return{canvasAndContext:l,frame:c}}returnCanvasAndContext(e){j.returnCanvasAndContext(e)}_renderTextToCanvas(e,t,i,s,n){var g,x,B,b;const{canvas:a,context:r}=n,o=D(t),l=M.measureText(e||" ",t),c=l.lines,u=l.lineHeight,f=l.lineWidths,w=l.maxLineWidth,S=l.fontProperties,C=a.height;if(r.resetTransform(),r.scale(s,s),r.textBaseline=t.textBaseline,(g=t._stroke)!=null&&g.width){const v=t._stroke;r.lineWidth=v.width,r.miterLimit=v.miterLimit,r.lineJoin=v.join,r.lineCap=v.cap}r.font=o;let _,p;const m=t.dropShadow?2:1;for(let v=0;v<m;++v){const T=t.dropShadow&&v===0,k=T?Math.ceil(Math.max(1,C)+i*2):0,Y=k*s;if(T){r.fillStyle="black",r.strokeStyle="black";const F=t.dropShadow,ot=F.color,ht=F.alpha;r.shadowColor=E.shared.setValue(ot).setAlpha(ht).toRgbaString();const lt=F.blur*s,U=F.distance*s;r.shadowBlur=lt,r.shadowOffsetX=Math.cos(F.angle)*U,r.shadowOffsetY=Math.sin(F.angle)*U+Y}else{if(r.fillStyle=t._fill?K(t._fill,r,l,i*2):null,(x=t._stroke)!=null&&x.width){const F=t._stroke.width*.5+i*2;r.strokeStyle=K(t._stroke,r,l,F)}r.shadowColor="black"}let W=(u-S.fontSize)/2;u-S.fontSize<0&&(W=0);const O=((B=t._stroke)==null?void 0:B.width)??0;for(let F=0;F<c.length;F++)_=O/2,p=O/2+F*u+S.ascent+W,t.align==="right"?_+=w-f[F]:t.align==="center"&&(_+=(w-f[F])/2),(b=t._stroke)!=null&&b.width&&this._drawLetterSpacing(c[F],t,n,_+i,p+i-k,!0),t._fill!==void 0&&this._drawLetterSpacing(c[F],t,n,_+i,p+i-k)}}_drawLetterSpacing(e,t,i,s,n,a=!1){const{context:r}=i,o=t.letterSpacing;let l=!1;if(M.experimentalLetterSpacingSupported&&(M.experimentalLetterSpacing?(r.letterSpacing=`${o}px`,r.textLetterSpacing=`${o}px`,l=!0):(r.letterSpacing="0px",r.textLetterSpacing="0px")),o===0||l){a?r.strokeText(e,s,n):r.fillText(e,s,n);return}let c=s;const u=M.graphemeSegmenter(e);let f=r.measureText(e).width,w=0;for(let S=0;S<u.length;++S){const C=u[S];a?r.strokeText(C,c,n):r.fillText(C,c,n);let _="";for(let p=S+1;p<u.length;++p)_+=u[p];w=r.measureText(_).width,c+=f-w+o,f=w}}}const zt=new kt;export{pt as A,Wt as B,zt as C,M as a,xt as g};
